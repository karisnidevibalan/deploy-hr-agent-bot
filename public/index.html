<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Bot - People Portal</title>
    <link rel="stylesheet" href="/ui.css">
    <link rel="icon" href="data:image/x-icon;," type="image/x-icon">
    <style>
        /* Compact bot message spacing & Milder overrides */
        .bot-message ul {
            margin: 8px 0 8px 22px;
            padding: 0;
        }

        .bot-message li {
            margin: 2px 0;
            line-height: 1.4;
        }

        .bot-message p {
            margin: 6px 0;
            line-height: 1.5;
        }

        .edit-form-modal {
            background: white;
            border: 1px solid #eef2f6;
            border-radius: var(--radius-md);
            padding: 16px;
            max-width: 85%;
            width: auto;
            min-width: 280px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-top: 8px;
            border-bottom-left-radius: 4px;
        }

        .edit-form-modal h4 {
            margin: 0 0 4px 0;
            font-size: 16px;
            color: var(--brand);
        }

        .edit-form-modal label {
            font-size: 13px;
            font-weight: 600;
            color: var(--muted);
            margin-bottom: -4px;
        }

        .edit-form-modal select,
        .edit-form-modal input,
        .edit-form-modal textarea {
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            font-size: 14px;
            background: #f8fafc;
            width: 100%;
            box-sizing: border-box;
            font-family: inherit;
        }

        .edit-form-modal .form-actions {
            display: flex;
            gap: 8px;
            margin-top: 6px;
        }

        .edit-form-modal button {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-save {
            background: var(--accent);
            color: white;
        }

        .btn-cancel {
            background: #f1f5f9;
            color: var(--brand);
        }

        .policy-type-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            display: none;
            flex-direction: column;
            gap: 16px;
            width: 300px;
        }

        .policy-type-modal h3 {
            margin: 0;
            font-size: 18px;
            color: var(--brand);
        }

        .policy-type-modal select {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 9999;
            display: none;
        }

        .duration-display {
            background: #f1f5f9;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            color: var(--brand);
            display: inline-block;
        }
    </style>
</head>

<body>

    <div class="modal-overlay" id="modalOverlay"></div>
    <div class="policy-type-modal" id="policyTypeModal">
        <h3>Select Policy Type</h3>
        <p style="font-size: 13px; color: var(--muted); margin: -8px 0 0 0;">What kind of policy are you uploading?</p>
        <select id="policyTypeSelect">
            <option value="leave">Leave Policy</option>
            <option value="holiday">Holiday List</option>
            <option value="wfh">WFH Policy</option>
            <option value="reimbursement">Reimbursement Policy</option>
        </select>
        <div style="display: flex; gap: 10px; margin-top: 8px;">
            <button onclick="confirmPolicyUpload()" class="btn-save"
                style="flex: 1; padding: 10px; border-radius: 8px; border: none; cursor: pointer;">Upload</button>
            <button onclick="closePolicyModal()" class="btn-cancel"
                style="flex: 1; padding: 10px; border-radius: 8px; border: none; cursor: pointer;">Cancel</button>
        </div>
    </div>

    <!-- Bot Launcher Button -->
    <div class="bot-launcher" id="botLauncher" onclick="toggleBot()">
        üí¨
    </div>

    <!-- Main Bot Container (Floating) -->
    <div class="container" id="botContainer">
        <div class="header">
            <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                <div style="display:flex; align-items:center; gap:12px;">
                    <img src="/avatar.png" alt="Bot Icon"
                        style="width:40px; height:40px; border-radius:50%; background:white; padding:2px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div>
                        <h1 style="margin:0; font-size:1.4em;">HR Assistant</h1>
                        <p style="margin:0; font-size:0.85em; opacity:0.9;">Always active for you</p>
                    </div>
                </div>
                <button onclick="toggleBot()"
                    style="background:none; border:none; color:var(--muted); cursor:pointer; font-size:1.2em;">‚úï</button>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="message bot-message">
                <p>Hello! How can I help you today?</p>
            </div>
        </div>

        <div class="loading" id="loadingDiv"
            style="display:none; text-align:center; padding:10px; font-size:0.9em; color:var(--muted); background: var(--bg-1);">
            ü§î Thinking...
        </div>

        <div class="input-container">
            <button id="ttsButton" class="tts-button" title="Toggle Voice" onclick="toggleTTS()">üîä</button>
            <input type="file" id="policyUploadInput" style="display:none" onchange="handlePolicyFileUpload(event)">
            <label for="policyUploadInput" class="mic-button" title="Upload & Update Policy"
                style="cursor:pointer; font-size: 18px;">üìé</label>
            <input type="text" id="messageInput" class="message-input" placeholder="Ask about leave, WFH..."
                onkeypress="handleKeyPress(event)" autocomplete="off">
            <button id="micButton" class="mic-button" title="Speak" onclick="toggleSpeechRecognition()">üé§</button>
            <button class="send-button" onclick="sendMessage()"></button>
        </div>
    </div>

    <script>
        // --- Configuration & State ---
        let editFormContainer = null;
        let ttsEnabled = false;
        const quickActions = [
            { label: 'Apply Leave', text: 'I want to apply for leave' },
            { label: 'Apply WFH', text: 'I want to apply for WFH' },
            { label: 'My Requests', text: 'Show my requests' },
            { label: 'Holidays', text: 'Show holiday list' }
        ];

        function toggleBot() {
            const container = document.getElementById('botContainer');
            container.classList.toggle('open');
            if (container.classList.contains('open')) {
                document.getElementById('messageInput').focus();
            }
        }

        function toggleTTS() {
            ttsEnabled = !ttsEnabled;
            const btn = document.getElementById('ttsButton');
            btn.innerText = ttsEnabled ? 'üîà' : 'üîä';
            btn.style.color = ttsEnabled ? 'var(--accent)' : 'var(--brand)';
            if (!ttsEnabled) window.speechSynthesis.cancel();
        }

        // --- Chat Functions ---
        function handleKeyPress(e) { if (e.key === 'Enter') sendMessage(); }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const msg = input.value.trim();
            if (!msg) return;

            addMessage(msg, true);
            input.value = '';
            await sendChatRequest({ message: msg });
        }

        function addMessage(msg, isUser = false) {
            const chat = document.getElementById('chatContainer');
            const div = document.createElement('div');
            div.className = `message ${isUser ? 'user-message' : 'bot-message'}`;

            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const messageBody = document.createElement('div');
            messageBody.className = 'message-body';

            if (isUser) {
                messageBody.innerText = msg;
            } else {
                messageBody.innerHTML = parseBotMessageMarkdown(msg);
                if (ttsEnabled) speak(msg);
            }

            const timeSpan = document.createElement('span');
            timeSpan.className = 'message-time';
            timeSpan.innerText = time;

            div.appendChild(messageBody);
            div.appendChild(timeSpan);
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        async function sendChatRequest(payload) {
            const loading = document.getElementById('loadingDiv');
            loading.style.display = 'block';

            try {
                const urlParams = new URLSearchParams(window.location.search);
                const ssoName = urlParams.get('name');
                const ssoEmail = urlParams.get('email');

                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-Id': getSessionId(),
                        'x-user-name': ssoName || '',
                        'x-user-email': ssoEmail || ''
                    },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                window.lastResponseData = data; // Store for edit form
                if (data.reply) addMessage(data.reply);

                // Show Quick Actions if it's a greeting or general start
                const greetingTriggers = ['how can i help', 'hello', 'hi', 'what can i do'];
                if (data.reply && greetingTriggers.some(t => data.reply.toLowerCase().includes(t))) {
                    showQuickActions();
                }

                if (data.showForm) {
                    showRequestForm(data.details, data.intent === 'apply_wfh', data.isEdit === false ? false : true);
                }

                if (data.showButtons) addConfirmationButtons(data.intent);
                if (data.intent && ['leave_created', 'wfh_created', 'confirmation_no'].includes(data.intent)) {
                    removeConfirmationButtons();
                    removeEditForm();
                    setTimeout(showQuickActions, 500); // Show quick actions after success
                }

            } catch (err) {
                console.error(err);
                addMessage('‚ùå Sorry, something went wrong.');
            } finally {
                loading.style.display = 'none';
            }
        }

        // --- UI Extensions ---
        function showQuickActions() {
            const chat = document.getElementById('chatContainer');
            const div = document.createElement('div');
            div.className = 'quick-actions-container';
            quickActions.forEach(action => {
                const pill = document.createElement('button');
                pill.className = 'quick-action-pill';
                pill.innerText = action.label;
                pill.onclick = () => {
                    addMessage(action.text, true);
                    sendChatRequest({ message: action.text });
                    div.remove();
                };
                div.appendChild(pill);
            });
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function addConfirmationButtons(intent) {
            removeConfirmationButtons();
            const chat = document.getElementById('chatContainer');
            const div = document.createElement('div');
            div.className = 'confirmation-buttons';
            div.dataset.intent = intent; // Store intent for edit form logic
            div.style.marginTop = '10px';
            div.innerHTML = `
                <button onclick="sendChatRequest({message:'yes'})" style="background:#22c55e;color:white;border:none;padding:6px 14px;border-radius:8px;cursor:pointer;font-weight:600;margin-right:8px;font-size:13px;">‚úÖ Yes</button>
                <button onclick="sendChatRequest({message:'no'})" style="background:#ef4444;color:white;border:none;padding:6px 14px;border-radius:8px;cursor:pointer;font-weight:600;margin-right:8px;font-size:13px;">‚ùå No</button>
                <button onclick="showEditForm()" style="background:#f59e42;color:white;border:none;padding:6px 14px;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;">‚úèÔ∏è Edit</button>
            `;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function removeConfirmationButtons() {
            document.querySelectorAll('.confirmation-buttons').forEach(el => el.remove());
        }

        function removeEditForm() {
            if (editFormContainer) {
                editFormContainer.remove();
                editFormContainer = null;
            }
        }


        function showRequestForm(prefillData = {}, isWFH = false, isEdit = true) {
            if (editFormContainer) removeEditForm();

            const chat = document.getElementById('chatContainer');
            // If isWFH wasn't passed, try to detect from active confirmation
            if (isWFH === null || isWFH === undefined) {
                const activeConfirmation = document.querySelector('.confirmation-buttons');
                isWFH = activeConfirmation && activeConfirmation.dataset.intent === 'confirm_wfh';
            }

            // Merge prefillData with lastResponseData if needed
            const lastData = isEdit ? (window.lastResponseData?.pendingRequest?.details || prefillData) : prefillData;

            editFormContainer = document.createElement('div');
            editFormContainer.className = 'edit-form-modal';
            editFormContainer.dataset.isEdit = isEdit;

            let typeField = '';
            if (!isWFH) {
                typeField = `
                    <label>Leave Type</label>
                    <select id="editLeaveType">
                        <option value="ANNUAL" ${lastData.leaveType === 'ANNUAL' ? 'selected' : ''}>Annual</option>
                        <option value="SICK" ${lastData.leaveType === 'SICK' ? 'selected' : ''}>Sick</option>
                        <option value="CASUAL" ${lastData.leaveType === 'CASUAL' ? 'selected' : ''}>Casual</option>
                    </select>
                `;
            }

            const startDate = lastData.startDate || lastData.date || '';
            const endDate = lastData.endDate || lastData.date || startDate || '';

            editFormContainer.innerHTML = `
                <h4>${isEdit ? 'Update' : 'Apply'} ${isWFH ? 'WFH' : 'Leave'}</h4>
                ${typeField}
                <div class="date-row" style="display:flex;gap:10px;">
                    <div style="flex:1">
                        <label>Start Date</label>
                        <input type="date" id="editStartDate" value="${startDate}" style="width:100%" onchange="updateDuration()">
                    </div>
                    <div style="flex:1">
                        <label>End Date</label>
                        <input type="date" id="editEndDate" value="${endDate}" style="width:100%" onchange="updateDuration()">
                    </div>
                </div>
                <div id="durationWrapper" style="margin-top:4px;">
                    <label>No. of Days (Working Days)</label>
                    <input type="number" id="durationInput" min="0.5" step="0.5" value="1" style="width:100%; padding:10px 12px; border-radius:8px; border:1px solid #e2e8f0; font-size:14px; background:#f8fafc;">
                </div>
                <label>Reason</label>
                <textarea id="editReason" rows="2">${lastData.reason || ''}</textarea>
                <div class="form-actions" id="formActions">
                    <button class="btn-save" onclick="submitEdit(${isWFH})">Save changes</button>
                    <button class="btn-cancel" onclick="removeEditForm()">Cancel</button>
                </div>
            `;
            chat.appendChild(editFormContainer);
            updateDuration(); // Auto-calculate initial value
            chat.scrollTop = chat.scrollHeight;
        }

        // Aliasing to keep old references working
        function showEditForm() { showRequestForm(); }

        function updateDuration() {
            const startStr = document.getElementById('editStartDate').value;
            const endStr = document.getElementById('editEndDate').value;
            if (!startStr) return;

            const days = calculateWorkingDays(startStr, endStr || startStr);
            document.getElementById('durationInput').value = days;
        }

        function calculateWorkingDays(startStr, endStr) {
            let start = new Date(startStr);
            let end = new Date(endStr);
            if (end < start) return 0;

            let count = 0;
            let cur = new Date(start);
            while (cur <= end) {
                let day = cur.getDay();
                if (day !== 0 && day !== 6) count++; // Not Sat or Sun
                cur.setDate(cur.getDate() + 1);
            }
            return count;
        }

        function submitEdit(isWFH) {
            const start = document.getElementById('editStartDate').value;
            const end = document.getElementById('editEndDate').value || start;
            const reason = document.getElementById('editReason').value;
            const type = isWFH ? 'WFH' : document.getElementById('editLeaveType').value;
            const days = document.getElementById('durationInput').value;

            if (!start) { alert('Please select a start date'); return; }

            // Validate that days is a positive number
            if (!days || parseFloat(days) <= 0) {
                alert('Please enter a valid number of days');
                return;
            }

            // Validate dates
            const startDate = new Date(start);
            const endDate = new Date(end);
            if (endDate < startDate) {
                alert('End date must be on or after start date');
                return;
            }

            // Store details for confirmation
            window.pendingLeaveDetails = {
                startDate: start,
                endDate: end,
                reason: reason,
                leaveType: isWFH ? null : type,
                durationDays: parseFloat(days),
                isWFH: isWFH
            };

            // Send confirmation as chat message
            const confirmMsg = `Confirm details: ${days} day(s) ${type} from ${start} to ${end}.`;
            addMessage(confirmMsg, false);

            // Show confirmation buttons
            const chat = document.getElementById('chatContainer');
            const div = document.createElement('div');
            div.className = 'confirmation-buttons';
            div.innerHTML = `
                <button onclick="confirmLeaveSubmit()" style="background:#22c55e;color:white;border:none;padding:6px 14px;border-radius:8px;cursor:pointer;font-weight:600;margin-right:8px;font-size:13px;">‚úÖ Confirm</button>
                <button onclick="showRequestForm(window.pendingLeaveDetails, ${isWFH})" style="background:#f59e42;color:white;border:none;padding:6px 14px;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;">‚úèÔ∏è Edit</button>
            `;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;

            // Remove the form
            removeEditForm();
        }

        function getFormDetails(isWFH) {
            const details = {
                startDate: document.getElementById('editStartDate').value,
                endDate: document.getElementById('editEndDate').value,
                reason: document.getElementById('editReason').value
            };
            if (!isWFH) details.leaveType = document.getElementById('editLeaveType').value;
            return details;
        }

        function confirmLeaveSubmit() {
            if (!window.pendingLeaveDetails) return;

            const details = {
                startDate: window.pendingLeaveDetails.startDate,
                endDate: window.pendingLeaveDetails.endDate,
                reason: window.pendingLeaveDetails.reason,
                durationDays: window.pendingLeaveDetails.durationDays
            };

            if (!window.pendingLeaveDetails.isWFH) {
                details.leaveType = window.pendingLeaveDetails.leaveType;
            } else {
                details.date = window.pendingLeaveDetails.startDate;
            }

            sendChatRequest({ message: 'edit', editDetails: details });
            removeConfirmationButtons();
            window.pendingLeaveDetails = null;
        }

        // --- Helpers ---
        function getSessionId() {
            let id = localStorage.getItem('hr_bot_session_id');
            if (!id) { id = Math.random().toString(36).substring(7); localStorage.setItem('hr_bot_session_id', id); }
            return id;
        }

        function parseBotMessageMarkdown(text) {
            let html = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            html = html.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            html = html.replace(/(^|\n)[\-*] (.*?)(?=\n|$)/g, '$1<ul><li>$2</li></ul>');
            html = html.replace(/\n\n/g, '<br><br>');
            html = html.replace(/\n/g, '<br>');
            return html;
        }

        function speak(text) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text.replace(/[*#]/g, ''));
            u.lang = 'en-IN';
            window.speechSynthesis.speak(u);
        }

        // --- STT ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = SpeechRecognition ? new SpeechRecognition() : null;
        if (recognition) {
            recognition.continuous = false;
            recognition.onresult = (e) => {
                document.getElementById('messageInput').value = e.results[0][0].transcript;
                sendMessage();
            };
            recognition.onstart = () => { document.getElementById('micButton').style.color = '#ef4444'; };
            recognition.onend = () => { document.getElementById('micButton').style.color = 'var(--brand)'; };
        }
        function toggleSpeechRecognition() { if (recognition) recognition.start(); }

        // --- Policy Upload Functions ---
        let selectedPolicyFile = null;

        function handlePolicyFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            selectedPolicyFile = file;
            document.getElementById('modalOverlay').style.display = 'block';
            document.getElementById('policyTypeModal').style.display = 'flex';
        }

        function closePolicyModal() {
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById('policyTypeModal').style.display = 'none';
            document.getElementById('policyUploadInput').value = '';
            selectedPolicyFile = null;
        }

        async function confirmPolicyUpload() {
            if (!selectedPolicyFile) return;

            const policyType = document.getElementById('policyTypeSelect').value;
            const formData = new FormData();
            formData.append('policyFile', selectedPolicyFile);
            formData.append('policyType', policyType);

            closePolicyModal();

            const loading = document.getElementById('loadingDiv');
            loading.innerText = '‚è≥ Updating policy...';
            loading.style.display = 'block';

            try {
                const urlParams = new URLSearchParams(window.location.search);
                const ssoEmail = urlParams.get('email');
                const ssoName = urlParams.get('name');

                const response = await fetch('/api/upload-policy', {
                    method: 'POST',
                    headers: {
                        'x-user-email': ssoEmail || '',
                        'x-user-name': ssoName || ''
                    },
                    body: formData
                });

                const data = await response.json();
                if (data.reply) {
                    addMessage(data.reply);
                } else if (response.status === 403) {
                    addMessage('‚ö†Ô∏è You are not authorized to update policies. Only Jashwanth M is authorized.');
                } else {
                    addMessage('‚ùå Failed to update policy. Please try again.');
                }
            } catch (err) {
                console.error(err);
                addMessage('‚ùå Error uploading document.');
            } finally {
                loading.innerText = 'ü§î Thinking...';
                loading.style.display = 'none';
            }
        }

    </script>
</body>

</html>